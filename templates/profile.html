{# Updated profile.html template #}
{% extends "layout.html" %}

{% block title %}{{ user.username }}'s Profile{% endblock %}

{% block content %}
    <!-- Profile Header -->
    <div class="profile-header">
        <h1>{{ user.username }}'s Profile</h1>
    </div>

    <!-- Main Container -->
    <div class="container profile-container">
        
        <!-- About Me Card -->
        <div class="about-me-card">
            <h3>About Me</h3>
            <p>{{ user.about_me if user.about_me else "This user has not written anything about themselves yet." }}</p>
        </div>

        <!-- Last Active Section -->
        <div class="last-active">
            <h3>Last Active</h3>
            <p>Active {{ (datetime.datetime.utcnow() - user.last_active).seconds }} seconds ago</p>
        </div>

        <!-- Edit About Me Section -->
        <div class="edit-about-me-form">
            <h3>Edit About Me</h3>
            <form method="POST" action="{{ url_for('update_about_me') }}">
                <textarea name="about_me" maxlength="500" rows="4">{{ user.about_me }}</textarea><br>
                <input type="submit" value="Update">
            </form>
        </div>
        
        <!-- Race Lists Section -->
        <div class="race-lists">
            <!-- Future Races Section -->
            <div class="future-races">
                <h3>Future Races</h3>
                <ul class="race-list">
                    {% for race in user.races if not race.is_completed %}
                        <li class="race-item">
                            <div class="race-info">
                                <strong>{{ race.race_name }}</strong> 
                                <span class="race-details">{{ race.race_distance }} on {{ race.race_date }}</span>
                            </div>
                            <div class="race-actions">
                                <form method="POST" action="{{ url_for('mark_race_complete', race_id=race.id) }}" class="complete-form">
                                    <label class="checkbox-container">
                                        Race Completed?
                                        <input type="checkbox" name="is_completed" onchange="this.form.submit()">
                                        <span class="checkmark"></span>
                                    </label>
                                </form>
                                <form method="POST" action="{{ url_for('remove_race_from_profile', race_id=race.id) }}">
                                    <button type="submit" class="remove-btn">Remove</button>
                                </form>
                            </div>
                        </li>
                    {% else %}
                        <li>No upcoming races.</li>
                    {% endfor %}
                </ul>
            </div>

            <!-- Past Races Section -->
            <div class="past-races">
                <h3>Past Races</h3>
                <ul class="race-list">
                    {% for race in user.races if race.is_completed %}
                        <li class="race-item">
                            <div class="race-info">
                                <strong>{{ race.race_name }}</strong>
                                <span class="race-details">{{ race.race_distance }} on {{ race.race_date }}</span>
                                {% if race.finish_time %}
                                    <span class="finish-time">Finish Time: {{ race.finish_time }}</span>
                                {% endif %}
                            </div>
                            <div class="race-notes">
                                {% if race.race_notes %}
                                    <p>{{ race.race_notes }}</p>
                                {% endif %}
                            </div>
                            <div class="race-actions">
                                <button onclick="toggleEditForm('{{ race.id }}')" class="edit-btn">Edit Details</button>
                                <form method="POST" action="{{ url_for('remove_race_from_profile', race_id=race.id) }}">
                                    <button type="submit" class="remove-btn">Remove</button>
                                </form>
                            </div>
                            <!-- Edit Race Details Form (hidden by default) -->
                            <div id="edit-form-{{ race.id }}" class="edit-race-form" style="display: none;">
                                <form method="POST" action="{{ url_for('update_race_details', race_id=race.id) }}">
                                    <div class="form-group">
                                        <label>Finish Time (HH:MM:SS):</label>
                                        <input type="text" name="finish_time" value="{{ race.finish_time }}" pattern="^\d{2}:\d{2}:\d{2}$">
                                    </div>
                                    <div class="form-group">
                                        <label>Race Notes:</label>
                                        <textarea name="race_notes" rows="3">{{ race.race_notes }}</textarea>
                                    </div>
                                    <button type="submit">Save Details</button>
                                </form>
                            </div>
                        </li>
                    {% else %}
                        <li>No completed races yet.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <!-- JavaScript for toggling edit forms -->
    <script>
        function toggleEditForm(raceId) {
            const form = document.getElementById(`edit-form-${raceId}`);
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }
    </script>
{% endblock %}